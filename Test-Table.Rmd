---
title: "Testing static and searchable multiverse table"
author: "Anna Elisabeth Riha"
date: '2022-06-23'
output: 
  html_document:
    toc: true 
    toc_depth: 3  
    number_sections: true 
    theme: united  
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Datasets

## $\texttt{brms::epilepsy}$ 

A data frame of 236 observations containing information on the following 9 variables.

**Age**: The age of the patients in years

**Base**: The seizure count at 8-weeks baseline

**Trt**: 0 or 1 indicating if the patient received anti-convulsant therapy

**patient**: patient number

**visit**: session number from 1 (first visit) to 4 (last visit)

**count**: seizure count between two visits

**obs**: observation number (unique identifier for each observation)

**zAge**: Standardized Age

**zBase**: Standardized Base

More information in [brms docs](https://paul-buerkner.github.io/brms/reference/epilepsy.html) and in [this example](https://cran.r-project.org/web/packages/bayesian/vignettes/GetStarted.html) introducing the $\texttt{bayesian}$-package. 

## Cash-gift treatment effects

A data frame of 435 observations containing information on 162 variables. Here, focus is on: 

**absalpha**: alpha waves (eeg measurements)

**treat**: cash-gift treatment

**cfemalea0**: 0 = male, 1 = female

**cweightlba0_r**: birthweight 

**cgestagewksa0_r**: gestagen 

**momeduyrsa0**: education of mother

**hhrevisedincomea0**: income 

**mracea0**: white (1), black (2), multiple (3), other (4), hispanic (5), unknown (6) 
  
**mgoodhealtha0**: health status of mother 

**mcigduringavgwka0_r**: smoking 

**malcduringavgwka0_r**: drinking 

More information in Troller-Renfree et al. (2021) ([pdf](https://www.pnas.org/content/pnas/119/5/e2115649119.full.pdf)) as well as the [blogpost](https://statmodeling.stat.columbia.edu/2022/01/25/im-skeptical-of-that-claim-that-cash-aid-to-poor-mothers-increases-brain-activity-in-babies/) by Andrew Gelman. Dataset available in the [supplementary materials](https://www.openicpsr.org/openicpsr/project/159422/version/V2/view;jsessionid=744DEB563344619A12721CB4868A04E7?path=/openicpsr/159422/fcr:versions/V2/Troller-Renfree-et-al.--2022--PNAS&type=folder) of the paper. 

# Static multiverse dictionary

```{r, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
library(tidyverse)
library(reactable)
library(htmltools)
```
## $\texttt{brms::epilepsy}$ 

```{r}
tabl_epi <- read_rds(here::here("results", "multi_dict_epi.rds")) %>%
  mutate(m = .universe,
         bulkess = round(bulkess),
         dist_ws = round(dist_ws, 2),
         elpd = round(elpd_loo, 1),
         se_elpd = round(se_elpd_loo, 1),
         p_loo = round(p_loo, 1),
         se_p_loo = round(se_p_loo, 1)) %>%
  select(-c(.universe, flagrhats, flagbulkess, elpd_loo, se_elpd_loo)) %>%
  select(m, everything())

knitr::kable(tabl_epi) %>%
  kableExtra::kable_styling(font_size = 11) %>%
  add_header_above(c("branches" = 3, "convergence" = 4, "priorsense" = 1, "PPC" = 1, "model comparison" = 6))
```

## Cash-gift treatment effects

```{r}
tabl_eeg <- read_rds(here::here("results", "multi_dict_eeg.rds")) %>%
  mutate(m = .universe,
         bulkess = round(bulkess),
         dist_ws = round(dist_ws, 2),
         elpd = round(elpd_loo, 1),
         se_elpd = round(se_elpd_loo, 1),
         p_loo = round(p_loo, 1),
         se_p_loo = round(se_p_loo, 1)) %>%
  select(-c(.universe, flagrhats, flagbulkess, elpd_loo, se_elpd_loo)) %>%
  select(m, everything())

knitr::kable(tabl_eeg) %>%
  kableExtra::kable_styling(font_size = 11) %>%
  add_header_above(c("branches" = 4, "convergence" = 4, "priorsense" = 1, "PPC" = 1, "model comparison" = 6))
```

# Searchable multiverse dictionary

```{js, echo=FALSE}
// Custom range filter with value label
function rangeFilter(column, state) {
  // Get min and max values from raw table data
  let min = Infinity
  let max = -500
  state.data.forEach(function(row) {
    const value = row[column.id]
    if (value < min) {
      min = Math.floor(value)
    } else if (value > max) {
      max = Math.ceil(value)
    }
  })

  const filterValue = column.filterValue || min
  const input = React.createElement('input', {
    type: 'range',
    value: filterValue,
    min: min,
    max: max,
    onChange: function(event) {
      // Set to undefined to clear the filter
      column.setFilter(event.target.value || undefined)
    },
    style: { width: '100%', marginRight: '8px' },
    'aria-label': 'Filter ' + column.name
  })

  return React.createElement(
    'div',
    { style: { display: 'flex', alignItems: 'center', height: '100%' } },
    [input, filterValue]
  )
}

// Filter method that filters numeric columns by minimum value
function filterMinValue(rows, columnId, filterValue) {
  return rows.filter(function(row) {
    return row.values[columnId] >= filterValue
  })
}
```

## $\texttt{brms::epilepsy}$ 

```{r epi-example}
reactable(tabl_epi, 
          filterable = TRUE, 
          # specify different options for columns
          columns = list(
            m = colDef(
              filterable = FALSE, 
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            formula = colDef(
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            family = colDef(
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            bulkess = colDef(
              filterable = TRUE,
              # Filter for values greater or equal
              filterMethod = JS("function(rows, columnId, filterValue) {
                return rows.filter(function(row) {
                  return row.values[columnId] >= filterValue
                  })
                }")
              ),
            dist_ws = colDef(filterable = FALSE),
            p_loo = colDef(filterable = FALSE),
            se_p_loo = colDef(filterable = FALSE),
            elpd = colDef(
              filterMethod = JS("filterMinValue"),
              filterInput = JS("rangeFilter")),
            se_elpd = colDef(filterable = FALSE)),
          # add groups 
          columnGroups = list(
            colGroup(name = "Branches", columns = c("m", "formula", "family")),
            colGroup(name = "Convergence", 
                     columns = c("flag_rhats", "divtrans", "bulkess", "flag_bulkess")),
            colGroup(name = "Prior Sensitivity", columns = c("pdc")),
            colGroup(name = "PPC", columns = c("dist_ws")),
            colGroup(name = "model comparison", 
                     columns = c("flag_pareto_ks", "nvars", "p_loo", "se_p_loo", "elpd", "se_elpd"))),
          defaultPageSize = 12, 
          elementId = "tabl-list")
```

## Cash-gift treatment effects

```{r eeg-example}
reactable(tabl_eeg, 
          filterable = TRUE, 
          # specify different options for columns
          columns = list(
            m = colDef(
              filterable = FALSE, 
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            pre_score_calculation = colDef(
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            formula = colDef(
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            family = colDef(
              sticky = "left",
              # Add a right border style to visually distinguish the sticky column
              style = list(borderRight = "1px solid #eee"),
              headerStyle = list(borderRight = "1px solid #eee")),
            bulkess = colDef(
              filterable = TRUE,
              # Filter for values greater or equal
              filterMethod = JS("function(rows, columnId, filterValue) {
                return rows.filter(function(row) {
                  return row.values[columnId] >= filterValue
                  })
                }")
              ),
            dist_ws = colDef(filterable = FALSE),
            p_loo = colDef(filterable = FALSE),
            se_p_loo = colDef(filterable = FALSE),
            elpd = colDef(
              filterMethod = JS("filterMinValue"),
              filterInput = JS("rangeFilter")),
            se_elpd = colDef(filterable = FALSE)),
          # add groups 
          columnGroups = list(
            colGroup(name = "Branches", 
                     columns = c("m", "pre_score_calculation", "formula", "family")),
            colGroup(name = "Convergence", 
                     columns = c("flag_rhats", "divtrans", "bulkess", "flag_bulkess")),
            colGroup(name = "Prior Sensitivity", columns = c("pdc")),
            colGroup(name = "PPC", columns = c("dist_ws")),
            colGroup(name = "model comparison", 
                     columns = c("flag_pareto_ks", "nvars", "p_loo", "se_p_loo", "elpd", "se_elpd"))),
          defaultPageSize = 16, 
          elementId = "tabl-list2")
```
